version: '3.8'

services:

# Workers
    scan-axe:
        image: equalifyapp/integration-axe:latest
        environment:
            - APP_PORT=8083
            - RABBIT_USERNAME=worker_axe
            - RABBIT_PASSWORD=drop_the_axe
            - RABBIT_HOST=rabbit
            - RABBIT_VHOST=gova11y
            - USE_PROXY=true
            - PROXY_HTTP=nginx:8888
            - PROXY_HTTPS=nginx:8888
            - LOG_LEVEL
        networks:
            - gova11y-int
        depends_on:
            - rabbit
        deploy:
            replicas: 3
            restart_policy:
                condition: on-failure

    scan-uppies:
        image: equalifyapp/integration-uppies:latest
        environment:
            - APP_PORT=8083
            - RABBIT_USERNAME=worker_uppies
            - RABBIT_PASSWORD=pass_the_uppies_please
            - RABBIT_HOST=rabbit
            - RABBIT_VHOST=gova11y
            - USE_PROXY=true
            - PROXY_HTTP=nginx:8888
            - PROXY_HTTPS=nginx:8888
            - LOG_LEVEL
        networks:
            - gova11y-int
        depends_on:
            - rabbit
        deploy:
            replicas: 3
            restart_policy:
                condition: on-failure

# DNS & Proxy Load Balance
    a11yproxy:
        image: qmcgaw/gluetun:latest
    #    ports:
    #        - "8388:8388/tcp"   # Shadowsocks Proxy
    #        - "8388:8388/udp"   # Shadowsocks Proxy
    #        - "8888:8888/tcp"   # HTTP Proxy
    #        - "8888:8888/udp"   # HTTP Proxy
    #        - "8000:8000/tcp"   # API
    #        - "9999:9999/tcp"   # Healthcheck
        cap_add:
            - NET_ADMIN
        environment:
            - VPN_SERVICE_PROVIDER=mullvad
            - VPN_TYPE=wireguard
            - WIREGUARD_PRIVATE_KEY
            - WIREGUARD_ADDRESSES=10.65.90.193/32
            - SERVER_COUNTRIES=USA
            # Shadowsocks Options: https://github.com/qdm12/gluetun/wiki/Shadowsocks-options
            - SHADOWSOCKS=on
            - SHADOWSOCKS_LOG=on
            - SHADOWSOCKS_ADDRESS=:8388
            - SHADOWSOCKS_PASSWORD
            - SHADOWSOCKS_CIPHER=chacha20-ietf-poly1305
            # HTTP Proxy: https://github.com/qdm12/gluetun/wiki/HTTP-proxy-options
            - HTTPPROXY=on
            - HTTPPROXY_LOG=on
            - HTTPPROXY_LISTENING_ADDRESS=:8888
            # DNS: https://github.com/qdm12/gluetun/wiki/DNS-options
            - DNS_ADDRESS=192.168.1.56
            - DOT_PRIVATE_ADDRESS=172.172.172.172
            - BLOCK_MALICIOUS=off
            - DOT_CACHING=off
            - DOT=off
            # Other Options: https://github.com/qdm12/gluetun/wiki/Other-options
            - TZ=AMERICA/NEW_YORK
            # Firewall: https://github.com/qdm12/gluetun/wiki/Firewall-options
            - FIREWALL_DEBUG=on
        deploy:
            replicas: 3
            restart_policy:
                condition: on-failure
        networks:
            - gova11y-int
            - gova11y-ext

    nginx:
        image: equalifyapp/nginx-proxy:latest
        ports:
            - "8888:80"
        networks:
            - gova11y-int
        deploy:
            replicas: 1
            restart_policy:
                condition: on-failure
# RabbitMQ Service
    rabbit:
        image: equalifyapp/a11y-rabbit:latest
        ports:
            - "4369:4369/tcp"
            - "5672:5672/tcp"
            - "15672:15672/tcp"
        networks:
            - gova11y-int
        deploy:
          restart_policy:
              condition: on-failure

# Matrix

    matrix:
        image: equalifyapp/a11ymatrix:latest
        ports:
            - "8087:8087/tcp"
        networks:
            - gova11y-int
            - gova11y-ext
        deploy:
            restart_policy:
                condition: on-failure




networks:
    gova11y-int:
    gova11y-ext: